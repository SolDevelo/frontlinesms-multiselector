(function(e){if(typeof define==="function"&&define.amd){define(["jquery"],e)}else if(typeof exports==="object"){module.exports=global.window&&global.window.$?e(global.window.$):function(t){if(!t.$&&!t.fn){throw new Error("Tokenfield requires a window object with jQuery or a jQuery instance")}return e(t.$||t)}}else{e(jQuery)}})(function(e,t){"use strict";var n=function(n,r){var i=this;this.$element=e(n);this.textDirection=this.$element.css("direction");this.options=e.extend(true,{},e.fn.tokenfield.defaults,{tokens:this.$element.val()},this.$element.data(),r);this._delimiters=typeof this.options.delimiter==="string"?[this.options.delimiter]:this.options.delimiter;this._triggerKeys=e.map(this._delimiters,function(e){return e.charCodeAt(0)});this._firstDelimiter=this._delimiters[0];var s=e.inArray(" ",this._delimiters),o=e.inArray("-",this._delimiters);if(s>=0)this._delimiters[s]="\\s";if(o>=0){delete this._delimiters[o];this._delimiters.unshift("-")}var u=["\\","$","[","{","^",".","|","?","*","+","(",")"];e.each(this._delimiters,function(t,n){var r=e.inArray(n,u);if(r>=0)i._delimiters[t]="\\"+n});var a=t&&typeof t.getMatchedCSSRules==="function"?t.getMatchedCSSRules(n):null,f=n.style.width,l,c=this.$element.width();if(a){e.each(a,function(e,t){if(t.style.width){l=t.style.width}})}var h=e("body").css("direction")==="rtl"?"right":"left",p={position:this.$element.css("position")};p[h]=this.$element.css(h);this.$element.data("original-styles",p).data("original-tabindex",this.$element.prop("tabindex")).css("position","absolute").css(h,"-10000px").prop("tabindex",-1);this.$wrapper=e('<div class="tokenfield form-control" />');if(this.$element.hasClass("input-lg"))this.$wrapper.addClass("input-lg");if(this.$element.hasClass("input-sm"))this.$wrapper.addClass("input-sm");if(this.textDirection==="rtl")this.$wrapper.addClass("rtl");var d=this.$element.prop("id")||(new Date).getTime()+""+Math.floor((1+Math.random())*100);this.$input=e('<input type="text" class="token-input" autocomplete="off" />').appendTo(this.$wrapper).prop("placeholder",this.$element.prop("placeholder")).prop("id",d+"-tokenfield").prop("tabindex",this.$element.data("original-tabindex"));var v=e('label[for="'+this.$element.prop("id")+'"]');if(v.length){v.prop("for",this.$input.prop("id"))}this.$copyHelper=e('<input type="text" />').css("position","absolute").css(h,"-10000px").prop("tabindex",-1).prependTo(this.$wrapper);if(f){this.$wrapper.css("width",f)}else if(l){this.$wrapper.css("width",l)}else if(this.$element.parents(".form-inline").length){this.$wrapper.width(c)}if(this.$element.prop("disabled")||this.$element.parents("fieldset[disabled]").length){this.disable()}this.$mirror=e('<span style="position:absolute; top:-999px; left:0; white-space:pre;"/>');this.$input.css("min-width",this.options.minWidth+"px");e.each(["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],function(e,t){i.$mirror[0].style[t]=i.$input.css(t)});this.$mirror.appendTo("body");this.$wrapper.insertBefore(this.$element);this.$element.prependTo(this.$wrapper);this.update();this.setTokens(this.options.tokens,false,false);this.listen();if(!e.isEmptyObject(this.options.autocomplete)){var m=this.textDirection==="rtl"?"right":"left";var g=e.extend({minLength:this.options.showAutocompleteOnFocus?0:null,position:{my:m+" top",at:m+" bottom",of:this.$wrapper}},this.options.autocomplete);this.$input.autocomplete(g)}if(!e.isEmptyObject(this.options.typeahead)){var y=e.extend({minLength:this.options.showAutocompleteOnFocus?0:null},this.options.typeahead);this.$input.typeahead(null,y);this.typeahead=true}this.$element.trigger("tokenfield:initialize")};n.prototype={constructor:n,createToken:function(t,n){if(typeof t==="string"){t={value:t,label:t}}if(typeof n==="undefined"){n=true}var r=this,i=e.trim(t.value),s=t.label&&t.label.length?e.trim(t.label):i;if(!i.length||!s.length||i.length<this.options.minLength)return;if(this.options.limit&&this.getTokens().length>=this.options.limit)return;var o=e.Event("tokenfield:preparetoken");o.token={value:i,label:s};this.$element.trigger(o);if(!o.token)return;i=o.token.value;s=o.token.label;if(!this.options.allowDuplicates&&e.grep(this.getTokens(),function(e){return e.value===i}).length){var u=e.Event("tokenfield:preventduplicate");u.token={value:i,label:s};this.$element.trigger(u);var a=this.$wrapper.find('.token[data-value="'+i+'"]').addClass("duplicate");setTimeout(function(){a.removeClass("duplicate")},250);return false}var f=e('<div class="token" />').attr("data-value",i).append('<span class="token-label" />').append('<a href="#" class="close" tabindex="-1">&times;</a>');if(this.$input.hasClass("tt-input")){this.$input.parent().before(f)}else{this.$input.before(f)}var l=f.find(".token-label"),c=f.find(".close");if(!this.maxTokenWidth){this.maxTokenWidth=this.$wrapper.width()-c.outerWidth()-parseInt(c.css("margin-left"),10)-parseInt(c.css("margin-right"),10)-parseInt(f.css("border-left-width"),10)-parseInt(f.css("border-right-width"),10)-parseInt(f.css("padding-left"),10)-parseInt(f.css("padding-right"),10);parseInt(l.css("border-left-width"),10)-parseInt(l.css("border-right-width"),10)-parseInt(l.css("padding-left"),10)-parseInt(l.css("padding-right"),10);parseInt(l.css("margin-left"),10)-parseInt(l.css("margin-right"),10)}l.text(s).css("max-width",this.maxTokenWidth);f.on("mousedown",function(e){if(r.disabled)return false;r.preventDeactivation=true}).on("click",function(e){if(r.disabled)return false;r.preventDeactivation=false;if(e.ctrlKey||e.metaKey){e.preventDefault();return r.toggle(f)}r.activate(f,e.shiftKey,e.shiftKey)}).on("dblclick",function(e){if(r.disabled||!r.options.allowEditing)return false;r.edit(f)});c.on("click",e.proxy(this.remove,this));var h=e.Event("tokenfield:createtoken");h.token=o.token;h.relatedTarget=f.get(0);this.$element.trigger(h);var p=e.Event("change");p.initiator="tokenfield";if(n){this.$element.val(this.getTokensList()).trigger(p)}this.update();return this.$input.get(0)},setTokens:function(t,n,r){if(!t)return;if(!n)this.$wrapper.find(".token").remove();if(typeof r==="undefined"){r=true}if(typeof t==="string"){if(this._delimiters.length){t=t.split(new RegExp("["+this._delimiters.join("")+"]"))}else{t=[t]}}var i=this;e.each(t,function(e,t){i.createToken(t,r)});return this.$element.get(0)},getTokenData:function(t){var n=t.map(function(){var t=e(this);return{value:t.attr("data-value"),label:t.find(".token-label").text()}}).get();if(n.length==1){n=n[0]}return n},getTokens:function(t){var n=this,r=[],i=t?".active":"";this.$wrapper.find(".token"+i).each(function(){r.push(n.getTokenData(e(this)))});return r},getTokensList:function(t,n,r){t=t||this._firstDelimiter;n=typeof n!=="undefined"&&n!==null?n:this.options.beautify;var i=t+(n&&t!==" "?" ":"");return e.map(this.getTokens(r),function(e){return e.value}).join(i)},getInput:function(){return this.$input.val()},listen:function(){var n=this;this.$element.on("change",e.proxy(this.change,this));this.$wrapper.on("mousedown",e.proxy(this.focusInput,this));this.$input.on("focus",e.proxy(this.focus,this)).on("blur",e.proxy(this.blur,this)).on("paste",e.proxy(this.paste,this)).on("keydown",e.proxy(this.keydown,this)).on("keypress",e.proxy(this.keypress,this)).on("keyup",e.proxy(this.keyup,this));this.$copyHelper.on("focus",e.proxy(this.focus,this)).on("blur",e.proxy(this.blur,this)).on("keydown",e.proxy(this.keydown,this)).on("keyup",e.proxy(this.keyup,this));this.$input.on("keypress",e.proxy(this.update,this)).on("keyup",e.proxy(this.update,this));this.$input.on("autocompletecreate",function(){var t=e(this).data("ui-autocomplete").menu.element;var r=n.$wrapper.outerWidth()-parseInt(t.css("border-left-width"),10)-parseInt(t.css("border-right-width"),10);t.css("min-width",r+"px")}).on("autocompleteselect",function(e,t){if(n.createToken(t.item)){n.$input.val("");if(n.$input.data("edit")){n.unedit(true)}}return false}).on("typeahead:selected",function(e,t,r){if(n.createToken(t)){n.$input.typeahead("val","");if(n.$input.data("edit")){n.unedit(true)}}}).on("typeahead:autocompleted",function(e,t,r){n.createToken(n.$input.val());n.$input.typeahead("val","");if(n.$input.data("edit")){n.unedit(true)}});e(t).on("resize",e.proxy(this.update,this))},keydown:function(t){function r(e){if(n.$input.is(document.activeElement)){if(n.$input.val().length>0)return;e+="All";var r=n.$input.hasClass("tt-input")?n.$input.parent()[e](".token:first"):n.$input[e](".token:first");if(!r.length)return;n.preventInputFocus=true;n.preventDeactivation=true;n.activate(r);t.preventDefault()}else{n[e](t.shiftKey);t.preventDefault()}}function i(r){if(!t.shiftKey)return;if(n.$input.is(document.activeElement)){if(n.$input.val().length>0)return;var i=n.$input.hasClass("tt-input")?n.$input.parent()[r+"All"](".token:first"):n.$input[r+"All"](".token:first");if(!i.length)return;n.activate(i)}var s=r==="prev"?"next":"prev",o=r==="prev"?"first":"last";n.firstActiveToken[s+"All"](".token").each(function(){n.deactivate(e(this))});n.activate(n.$wrapper.find(".token:"+o),true,true);t.preventDefault()}if(!this.focused)return;var n=this;switch(t.keyCode){case 8:if(!this.$input.is(document.activeElement))break;this.lastInputValue=this.$input.val();break;case 37:r(this.textDirection==="rtl"?"next":"prev");break;case 38:i("prev");break;case 39:r(this.textDirection==="rtl"?"prev":"next");break;case 40:i("next");break;case 65:if(this.$input.val().length>0||!(t.ctrlKey||t.metaKey))break;this.activateAll();t.preventDefault();break;case 9:case 13:if(this.$input.data("ui-autocomplete")&&this.$input.data("ui-autocomplete").menu.element.find("li:has(a.ui-state-focus)").length)break;if(this.$input.hasClass("tt-input")&&this.$wrapper.find(".tt-cursor").length)break;if(this.$input.hasClass("tt-input")&&this.$wrapper.find(".tt-hint").val().length)break;if(this.$input.is(document.activeElement)&&this.$input.val().length||this.$input.data("edit")){return this.createTokensFromInput(t,this.$input.data("edit"))}if(t.keyCode===13){if(!this.$copyHelper.is(document.activeElement)||this.$wrapper.find(".token.active").length!==1)break;if(!n.options.allowEditing)break;this.edit(this.$wrapper.find(".token.active"))}}this.lastKeyDown=t.keyCode},keypress:function(t){this.lastKeyPressCode=t.keyCode;this.lastKeyPressCharCode=t.charCode;if(e.inArray(t.charCode,this._triggerKeys)!==-1&&this.$input.is(document.activeElement)){if(this.$input.val()){this.createTokensFromInput(t)}return false}},keyup:function(e){this.preventInputFocus=false;if(!this.focused)return;switch(e.keyCode){case 8:if(this.$input.is(document.activeElement)){if(this.$input.val().length||this.lastInputValue.length&&this.lastKeyDown===8)break;this.preventDeactivation=true;var t=this.$input.hasClass("tt-input")?this.$input.parent().prevAll(".token:first"):this.$input.prevAll(".token:first");if(!t.length)break;this.activate(t)}else{this.remove(e)}break;case 46:this.remove(e,"next");break}this.lastKeyUp=e.keyCode},focus:function(e){this.focused=true;this.$wrapper.addClass("focus");if(this.$input.is(document.activeElement)){this.$wrapper.find(".active").removeClass("active");this.firstActiveToken=null;if(this.options.showAutocompleteOnFocus){this.search()}}},blur:function(e){this.focused=false;this.$wrapper.removeClass("focus");if(!this.preventDeactivation&&!this.$element.is(document.activeElement)){this.$wrapper.find(".active").removeClass("active");this.firstActiveToken=null}if(!this.preventCreateTokens&&(this.$input.data("edit")&&!this.$input.is(document.activeElement)||this.options.createTokensOnBlur)){this.createTokensFromInput(e)}this.preventDeactivation=false;this.preventCreateTokens=false},paste:function(e){var t=this;setTimeout(function(){t.createTokensFromInput(e)},1)},change:function(e){if(e.initiator==="tokenfield")return;this.setTokens(this.$element.val())},createTokensFromInput:function(e,t){if(this.$input.val().length<this.options.minLength)return;var n=this.getTokensList();this.setTokens(this.$input.val(),true);if(n==this.getTokensList()&&this.$input.val().length)return false;if(this.$input.hasClass("tt-input")){this.$input.typeahead("val","")}else{this.$input.val("")}if(this.$input.data("edit")){this.unedit(t)}return false},next:function(e){if(e){var t=this.$wrapper.find(".active:first"),n=t&&this.firstActiveToken?t.index()<this.firstActiveToken.index():false;if(n)return this.deactivate(t)}var r=this.$wrapper.find(".active:last"),i=r.nextAll(".token:first");if(!i.length){this.$input.focus();return}this.activate(i,e)},prev:function(e){if(e){var t=this.$wrapper.find(".active:last"),n=t&&this.firstActiveToken?t.index()>this.firstActiveToken.index():false;if(n)return this.deactivate(t)}var r=this.$wrapper.find(".active:first"),i=r.prevAll(".token:first");if(!i.length){i=this.$wrapper.find(".token:first")}if(!i.length&&!e){this.$input.focus();return}this.activate(i,e)},activate:function(t,n,r,i){if(!t)return;if(typeof i==="undefined")var i=true;if(r)var n=true;this.$copyHelper.focus();if(!n){this.$wrapper.find(".active").removeClass("active");if(i){this.firstActiveToken=t}else{delete this.firstActiveToken}}if(r&&this.firstActiveToken){var s=this.firstActiveToken.index()-2,o=t.index()-2,u=this;this.$wrapper.find(".token").slice(Math.min(s,o)+1,Math.max(s,o)).each(function(){u.activate(e(this),true)})}t.addClass("active");this.$copyHelper.val(this.getTokensList(null,null,true)).select()},activateAll:function(){var t=this;this.$wrapper.find(".token").each(function(n){t.activate(e(this),n!==0,false,false)})},deactivate:function(e){if(!e)return;e.removeClass("active");this.$copyHelper.val(this.getTokensList(null,null,true)).select()},toggle:function(e){if(!e)return;e.toggleClass("active");this.$copyHelper.val(this.getTokensList(null,null,true)).select()},edit:function(t){if(!t)return;var n=t.data("value"),r=t.find(".token-label").text();var i=e.Event("tokenfield:edittoken");i.token={value:n,label:r};i.relatedTarget=t.get(0);this.$element.trigger(i);if(!i.token)return;n=i.token.value;r=i.token.label;t.find(".token-label").text(n);var s=t.outerWidth();var o=this.$input.hasClass("tt-input")?this.$input.parent():this.$input;t.replaceWith(o);this.preventCreateTokens=true;this.$input.val(n).select().data("edit",true);this.update()},unedit:function(e){var t=this.$input.hasClass("tt-input")?this.$input.parent():this.$input;t.appendTo(this.$wrapper);this.$input.data("edit",false);this.$mirror.text("");this.update();if(e){var n=this;setTimeout(function(){n.$input.focus()},1)}},remove:function(t,n){if(this.$input.is(document.activeElement)||this.disabled)return;var r=t.type==="click"?e(t.target).closest(".token"):this.$wrapper.find(".token.active");if(t.type!=="click"){if(!n)var n="prev";this[n]();if(n==="prev")var i=r.first().prevAll(".token:first").length===0}var s=e.Event("tokenfield:removetoken");s.token=this.getTokenData(r);var o=e.Event("change");o.initiator="tokenfield";r.remove();this.$element.val(this.getTokensList()).trigger(s).trigger(o);if(!this.$wrapper.find(".token").length||t.type==="click"||i)this.$input.focus();this.update();t.preventDefault();t.stopPropagation()},update:function(e){},focusInput:function(t){if(e(t.target).closest(".token").length||e(t.target).closest(".token-input").length)return;var n=this;setTimeout(function(){n.$input.focus()},0)},search:function(){if(this.$input.data("ui-autocomplete")){this.$input.autocomplete("search")}},disable:function(){this.disabled=true;this.$input.prop("disabled",true);this.$element.prop("disabled",true);this.$wrapper.addClass("disabled")},enable:function(){this.disabled=false;this.$input.prop("disabled",false);this.$element.prop("disabled",false);this.$wrapper.removeClass("disabled")},destroy:function(){this.$element.val(this.getTokensList());this.$element.css(this.$element.data("original-styles"));this.$element.prop("tabindex",this.$element.data("original-tabindex"));var t=e('label[for="'+this.$input.prop("id")+'"]');if(t.length){t.prop("for",this.$element.prop("id"))}this.$element.insertBefore(this.$wrapper);this.$element.removeData("original-styles");this.$element.removeData("original-tabindex");this.$element.removeData("bs.tokenfield");this.$wrapper.remove();var n=this.$element;delete this;return n}};var r=e.fn.tokenfield;e.fn.tokenfield=function(t,r){var i,s=[];Array.prototype.push.apply(s,arguments);var o=this.each(function(){var o=e(this),u=o.data("bs.tokenfield"),a=typeof t=="object"&&t;if(typeof t==="string"&&u&&u[t]){s.shift();i=u[t].apply(u,s)}else{if(!u&&typeof t!=="string"&&!r)o.data("bs.tokenfield",u=new n(this,a))}});return typeof i!=="undefined"?i:o};e.fn.tokenfield.defaults={minWidth:60,minLength:0,allowDuplicates:false,allowEditing:true,limit:0,autocomplete:{},typeahead:{},showAutocompleteOnFocus:false,createTokensOnBlur:false,delimiter:",",beautify:true};e.fn.tokenfield.Constructor=n;e.fn.tokenfield.noConflict=function(){e.fn.tokenfield=r;return this};return n})
